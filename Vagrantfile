
Vagrant.configure("2") do |config|
  
  config.vm.define "nvip" do |nvip|
    nvip.vm.box = "ubuntu/focal64"
	
	nvip.vm.provider "virtualbox" do |v|
      v.memory = 16000
      v.cpus = 2
    end

	nvip.vm.network "private_network", ip: "192.168.50.3"
	nvip.vm.network "forwarded_port", guest: 8080, host: 8080
	nvip.vm.network "forwarded_port", guest: 3306, host: 3306
		
	nvip.vm.provision "shell", inline: <<-SHELL
		
		# Install JAVA
		echo "\n----- Installing Java..."
		add-apt-repository ppa:openjdk-r/ppa -y
		apt-get update
		apt-get -y install openjdk-8-jdk
		update-alternatives --config java
		
		# Install Tomcat9
		apt update
		apt -y install tomcat9 tomcat9-admin
		
		# Install systemctl
		apt-get install -y systemd
		
		# Install MySQL 8
		echo "\n----- Installing MySQL..."
		# Setting MySQL root user password root/root	
		debconf-set-selections <<< 'mysql-server mysql-server/root_password password root'
		debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password root'
		# Installing packages
		apt-get install -y mysql-server mysql-client
		sudo service mysql restart
		
		# Install Git & Git LFS
		echo "\n----- Installing Git..."
		apt-get -y -q install git-all
		
		echo "\n----- Installing Git LFS following instructions @github.com/git-lfs/git-lfs/wiki/Installation#ubuntu..."
		sudo curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
		yes | sudo apt-get install git-lfs
		sudo git lfs install
	
		# Clone project
		echo "\n----- Cloning project from Git repo..."
		sudo git clone https://github.com/SoftwareDesignLab/vulnerability-intelligence-platform.git
		echo "\n----- Repo cloned!"
		
		# Create database
		echo "\n----- Creating db..."
		mysql -uroot -proot < ./vulnerability-intelligence-platform/nvip_data/mysql-database/CreateAndInitializeDb.sql
		echo "\n----- MySQL database created and initialized!"
			
		# Install Maven 
		echo "\n----- Installing maven..."
		apt-get -y -q install maven
		
		# Update CA certs, needed to use SSL for mvn!
		sudo update-ca-certificates -f
		echo "\n----- Maven installed!"
		
		# Build backend and ui
		echo "\n----- Building the backend..."
		mvn -f vulnerability-intelligence-platform/nvip_backend/pom.xml clean package -Dmaven.test.skip=true
		cp vulnerability-intelligence-platform/nvip_backend/target/nvip-1.0.jar vulnerability-intelligence-platform/nvip-1.0.jar
		echo "\n----- Backend build done!"
		sleep 3s
		
		echo "\n----- Building the ui..."
		mvn -f vulnerability-intelligence-platform/nvip_ui/pom.xml clean package -Dmaven.test.skip=true
		cp vulnerability-intelligence-platform/nvip_ui/target/nvip_ui-1.0.war /var/lib/tomcat9/webapps/
		echo "\n----- UI build done! Open http://192.168.50.3:8080/nvip_ui-1.0 in browser and register to login!"
		
		echo "\n----- All done!!"
		echo "\n----- To run the system: (1) Connect to the VM [vagrant ssh nvip], (2) Navigate to the root dir [cd vulnerability-intelligence-platform] and (3) Start the system [sudo java -Xms8G -Xmx12G -jar nvip-1.0.jar]"
		
		sleep 5s
	 
	SHELL
  end
end
